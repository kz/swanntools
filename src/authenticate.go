package main

import (
	"flag"
	"os"
	"encoding/hex"
	"strconv"
	"fmt"
)

// Declare values of the byte arrays required in string form
const IntentValues = "00000000000000000000010000000aXX000000292300000000001c010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
const IntentResponseValues = "000000010000000aXX000000292300000000001c010000000100961200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
const AuthValues = "000000000000000000000100000019YY0000000000000000000054000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
const SuccessfulLoginValues = "0800000002000000"
const FailedLoginValues = "08000000FFFFFFFF"

// Initialize flag variables
var dest string
var user string
var pass string

func init() {
	// Retrieve the command line flags
	flag.StringVar(&dest, "dest", "", "The destination of the DVR in the format host:port")
	flag.StringVar(&user, "user", "", "Username to authenticate with")
	flag.StringVar(&pass, "pass", "", "Password to authenticate with")
}

func getIntentMessage(intentValue string) []byte {
	hexValues := IntentValues[:30] + intentValue + IntentValues[32:]
	byteArray, _ := hex.DecodeString(hexValues)
	return byteArray
}

func getIntentResponseMessage(intentValue string) []byte {
	hexValues := IntentResponseValues[:16] + intentValue + IntentResponseValues[18:]
	byteArray, _ := hex.DecodeString(hexValues)
	return byteArray
}

func getLoginMessage(user string, pass string, intentValue string) []byte {
	// Add incremented intent value to hex values
	parsedIntentValue, _ := strconv.ParseInt(intentValue, 16, 8)
	incIntentHexValue := fmt.Sprintf("%x", parsedIntentValue+1)
	hexValues := AuthValues[:30] + incIntentHexValue + AuthValues[32:]

	// Add username to hex values
	for i, v := range user {
		startPos := 54 + 2*i
		endPos := 56 + 2*i
		hexValues = hexValues[:startPos] + fmt.Sprintf("%x", int(v)) + hexValues[endPos:]
	}

	// Add password to hex values
	for i, v := range pass {
		startPos := 118 + 2*i
		endPos := 120 + 2*i
		hexValues = hexValues[:startPos] + fmt.Sprintf("%x", int(v)) + hexValues[endPos:]
	}

	byteArray, _ := hex.DecodeString(hexValues)
	return byteArray

}

func main() {
	// Ensure that the command line flags are not empty
	if dest == "" || user == "" || pass == "" {
		flag.Usage()
		os.Exit(1)
	}
}
